# セカンドオーダーSQLインジェクション


* SQLインジェクションの対策として、
「入力値を適切にエスケープ(サニタイジング)する」というものがある。


* しかし、その対策をしていても可能となる攻撃がある！
それが「セカンドオーダーSQLインジェクション」

#### 概要  
  (悪意のある)文字列を入力する際には、見た目上は何も起こらず、
  その文字列が呼び出されるときにはじめて効力を発揮するもの。




例)  
*  新規ユーザー登録して、パスワードを変更する(ログイン後、新しいパスワードを入力)という流れを想定


* 新規ユーザー登録
  - ユーザID：[admin' --]
  - パスワード：[pass]

  `(1) INSERT INTO ユーザマスタ VALUES ('admin'' --', 'pass')`  
    →適切にエスケープされ、ユーザID[admin' --], パスワード[pass]と登録される。



* ユーザID・現在のパスワードを入力し、ログインする。
    - ユーザID:[admin' --]
    - パスワード:[pass]

    `(2) SELECT * FROM ユーザマスタ WHERE ユーザID = 'admin'' --' AND パスワード = 'pass'`



* 新しいパスワードを入力する
    - 新しいパスワード:[newPass]

    `(3) UPDATE ユーザマスタ SET パスワード = 'newPass' WHERE ユーザID = 'admin' --''`  
      →ユーザID[admin' --]はDBに格納された値なので、そのままの形で用いられる。



  すると、(3)のSQL文は  
    `UPDATE ユーザマスタ SET パスワード = 'newPass' WHERE ユーザID = 'admin'`  
    となり、**adminのパスワードを自由に変更できるようになる** という結果に。



#### 原因
  外部から受け取る値に対してはエスケープ（サニタイジング）処理を行っているが、
  内部から受け取る値に対して何もしていないから。


#### 対策
  外部からでも内部からでも、受け取る値に対して適切なエスケープ処理を行う。
  (文字列連結でSQL文を構築する全ての箇所で対策が必要)

以上です。
